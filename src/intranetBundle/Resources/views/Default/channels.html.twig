{% extends 'intranetBundle::layout.html.twig' %}

 {% block contenido %}
<script>
            var app = angular.module('MyApp',['ngRoute', 'ngMaterial', 'ngMessages', 'material.svgAssetsCache', 'ngMdIcons']);
            app.config(function($interpolateProvider){
                $interpolateProvider.startSymbol('{[{').endSymbol('}]}');
            });

            app.controller('channelController', channelController);
            app.controller('updateChannelDialogController', updateChannelDialogController);
            
            
            function channelController($scope, $mdDialog, $http){
                $scope.getAllChannels = function(){
                    $http({
                        method: 'GET',
                        url: window.location.pathname+'/../../api/channels',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        $scope.channelsList = response.data;
                        console.log($scope.channelsList);
                    }, function error(response){
                        console.log("Error:" +response.statusText);
                    });
                }

                $scope.showUpdateChannelDialog = function(ev, channel) {
                    $mdDialog.show({
                        templateUrl: "{{path('intranet_main_channel_dialog')}}",
                        locals: {
                            currentChannel: channel
                        }, 
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        controller: updateChannelDialogController,
                        onRemoving: $scope.getAllChannels
                    });
                    //alert(user.name);
                }

                $scope.deleteChannel = function(name){
                    
                     $http({
                        method: 'DELETE',
                        url: window.location.pathname+'/../../api/channel/'+name,
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                         $scope.getAllChannels();
                    }, function error(response){
                        console.log("Error al delete:" +response.statusText);
                    });
                }
            }


            function updateChannelDialogController($scope, $mdDialog, $http, currentChannel){
                $scope.channel = currentChannel;
                var oldname=$scope.channel.name;
                $scope.getInfo = function(){
                    
                    $http({
                        method: 'GET',
                        url: window.location.pathname+'/../../api/channel/'+$scope.channel.name+'/users',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        
                        $scope.allData = {
                            "channelData": response.data.channelData,
                            "channelUsers": $.map(response.data.usersInChannel, function(elem){return elem.login}),
                            "allUsers": response.data.allUsers
                        };
                        
                        console.log($scope.allData.channelData);

                        $scope.allUsers = $scope.allData.allUsers;
                        $scope.usersInChannel = $scope.allData.allUsers.filter(function(user){
                            
                            if (($scope.allData.channelUsers).indexOf(user.login) > -1)
                                return user;
                        });
                       
                        
                    }, function error(response){
                        console.log("Error =( line:84:" +response.statusText);
                    });



                };
                
                $scope.closeDialog = function() {
                    $mdDialog.hide();
                };

                 $scope.alreadyIn = function(user){
                    
                    return ($scope.allData.channelUsers).indexOf(user.login) > -1;
                };
                
                $scope.toggle = function(user){
                 
                    var index = ($scope.allData.channelUsers).indexOf(user.login);
                    
                    if (index > -1)
                        ($scope.allData.channelUsers).splice(index, 1);
                    else
                        ($scope.allData.channelUsers).push(user.login);
                };
                      
               

                $scope.update=function(id){
                alert($scope.allData.channelUsers);
                //Recoger los datos del modal y pasarlos a la bd mediante AJAX?
                    $http({
                            method: 'PATCH',
                            url: window.location.pathname+'/../../api/channel/'+$scope.channel.id,
                            data: {
                                name: $scope.channel.name,
                            	usersInChannel: $scope.allData.channelUsers
                            },
                            contentType: 'application/json',
                            dataType: 'json',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function success(response){
                            console.log("Party time");
                            $scope.closeDialog();
                        }, function error(response){
                            console.log("Error:" +response.statusText);
                        });                    
                    }/*
                    $http({
                        method: 'PATCH',
                        url: window.location.pathname+'/../../api/tasks/'+$id,
                        data: {
                            title: $scope.allData.taskData[0].title,
                            content: $scope.allData.taskData[0].content,
                            usersInTask: $scope.allData.taskUsers
                        },
                        contentType: 'application/json',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        
                        $scope.closeDialog();
                    }, function error(response){
                        console.log("Error:" +response.statusText);
                    });*/
            }
   
</script>
















<div ng-cloak ng-app="MyApp" ng-controller="channelController" layout-align="center start" style="width: 80%;">
    
    <md-list ng-init="getAllChannels()">
        <md-divider></md-divider>
        <md-divider></md-divider>

        <md-list-item style="font-size: large" ng-model="prueba">
            <span style="width: 100%">Name</span><!--
            <span style="width: 50%">Login</span>-->
        </md-list-item>

        <md-divider></md-divider>
        <md-divider></md-divider>

        <div ng-repeat="channel in channelsList">
            <md-list-item ng-click="showUpdateChannelDialog($event, channel)">
    
                <span style="width: 100%">{[{channel.name}]}</span>
                <!--<span style="width: 50%">{[{user.login}]}</span>-->
                <div>
                    <md-button style="width: 10%" class="md-raised md-warn" ng-click="deleteChannel(channel.name)">
                        Delete <!--{[{channel.name}]}-->
                    </md-button> 
                </div>
            
            </md-list-item>
            <md-divider></md-divider>
        </div>
    </md-list>
</div>



















<table border=1>
<tr>
    <th style="padding-left: 10px;padding-right: 10px;">{% trans %}Name{% endtrans %}</th>
</tr>
{% for c in listChannels %}
<tr>
    <td style="padding-left: 10px;padding-right: 10px;">
    <form action='{{ path('intranet_crudchannel') }}' method='post'>
          <input type="submit" name="nameChannel" value="{{c.name}}" >
          <input type="hidden" value="{{ c.id }}" name="id">
    </form>
    </td>
</tr>
{% endfor %}
</table>
<br><br>

<form action="{{ path('intranet_newchannel')}}" method="post" style="border: 1px solid;width: 500px;">
    <input type="submit" name="newChannel" value="{% trans %}new_channel{% endtrans %}">
  </form>


{% endblock %}
