{% extends 'intranetBundle::layout.html.twig' %}

{% block contenido %}
<script>
            var app = angular.module('MyApp',['ngRoute', 'ngMaterial', 'ngMessages', 'material.svgAssetsCache', 'ngMdIcons']);
            app.config(function($interpolateProvider){
                $interpolateProvider.startSymbol('{[{').endSymbol('}]}');
            });

            app.controller('newsController', newsController);
            app.controller('updateNewDialogController ', updateNewDialogController );


            function newsController($rootScope, $scope, $mdDialog, $http){

                $scope.getAllNews = function(){
                    $http({
                            method: 'GET',
                            url: window.location.pathname+'/../../api/channels',
                            dataType: 'json',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function success(response){
                            $scope.items = response.data;
                            //$scope.items.unshift('ALL');
                        }, function error(response){
                            console.log("Error:" +response.statusText);
                        });

                    $scope.selectedItem;
                    $scope.selected = function($ch){
                        $rootScope.cha=$ch;
                        if($ch==null){
                            var urlapi=window.location.pathname+'/../../api/news';

                        }else{
                            var urlapi=window.location.pathname+'/../../api/news/'+$ch;
                         }
                        $http({
                            method: 'GET',
                            url: urlapi,
                            dataType: 'json',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function success(response){
                            $scope.newsList = response.data;
                            //console.log($scope.newsList);
                        }, function error(response){
                            console.log("Error:" +response.statusText);
                        });
                    }
                    $rootScope.cha=$scope.selectedItem;
                    $rootScope.selected = function($ch){
                        if($ch==null){
                            var urlapi=window.location.pathname+'/../../api/news';

                        }else{
                            var urlapi=window.location.pathname+'/../../api/news/'+$ch;
                         }
                        $http({
                            method: 'GET',
                            url: urlapi,
                            dataType: 'json',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function success(response){
                            $scope.newsList = response.data;
                        }, function error(response){
                            console.log("Error:" +response.statusText);
                        });
                    }
                }

                $scope.deleteNew = function(ev, n){
                    $mdDialog.show({
                        templateUrl: "{{path('intranet_delete_dialog')}}",
                        locals: {
                            currentNew: n
                        },
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        controller: function deleteNewDialogController($scope, $mdDialog, $http, currentNew){
                                        $scope.new = currentNew;

                                        $scope.closeDialog = function(){
                                            $mdDialog.hide();
                                            $rootScope.selected($rootScope.cha);
                                         };

                                       $scope.delete=function(){
                                            $http({
                                                method: 'DELETE',
                                                url: window.location.pathname+'/../../api/new/'+$scope.new.id,
                                                dataType: 'json',
                                                headers: {'Content-Type': 'application/json'}
                                            })
                                            .then(function success(response){
                                                $scope.closeDialog();
                                            }, function error(response){
                                                console.log("Error al delete:" +response.statusText);
                                            });
                                        };
                                    },
                        //deleteNewDialogController,
                        //onRemoving: console.log("cerraste el dialogo") //$scope.selected(null)
                    });
                }

                $scope.readNewDialog = function(ev, n) {
                    $mdDialog.show({
                        templateUrl: "{{path('intranet_main_new_dialog')}}",
                        locals: {
                            currentNew: n
                        },
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        controller: updateNewDialogController,
                        onRemoving: $scope.getAllNews
                    });
                }

                $scope.showCreateNewDialog = function(ev) {

                    $mdDialog.show({
                        templateUrl: "{{path('intranet_main_create_new_dialog')}}",
                        parent: angular.element(document.body),
                        targetEvent: ev,
                        clickOutsideToClose: true,
                        controller: createNewDialogController,
                        onRemoving: $scope.getAllNews
                    });
                }
            }

            function updateNewDialogController($scope, $mdDialog, $http, currentNew){
                $scope.new = currentNew;
                $scope.getInfo = function(){

                    $http({
                        method: 'GET',
                        url: window.location.pathname+'/../../api/new/'+$scope.new.id+'/channels',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){

                        $scope.allData = {
                            "newData": response.data.channelData,
                            "channelsInNew": $.map(response.data.channelsInNew, function(elem){return elem.name}),
                            "allChannels": response.data.allChannels
                        };

                        $scope.allChannels = $scope.allData.allChannels;
                        $scope.channelsInNew = $scope.allData.allChannels.filter(function(channel){

                            if (($scope.allData.channelsInNew).indexOf(channel.name) > -1)
                                return channel;
                        });

                    }, function error(response){
                        console.log("Error:" +response.statusText);
                    });
                };

                $scope.closeDialog = function(){
                    $mdDialog.hide();
                 };

                $scope.alreadyIn = function(channel){

                    return ($scope.allData.channelsInNew).indexOf(channel.name) > -1;
                };

                $scope.toggle = function(channel){

                    var index = ($scope.allData.channelsInNew).indexOf(channel.name);

                    if (index > -1)
                        ($scope.allData.channelsInNew).splice(index, 1);
                    else
                        ($scope.allData.channelsInNew).push(channel.name);
                };

               $scope.update=function(id){

                    $http({
                            method: 'PATCH',
                            url: window.location.pathname+'/../../api/new/'+id,
                            data: {
                                title: $scope.new.title,
                                content: $scope.new.content,
                                channelsInNew: $scope.allData.channelsInNew
                            },
                            contentType: 'application/json',
                            dataType: 'json',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function success(response){
                            $scope.closeDialog();
                        }, function error(response){
                            console.log("Error:" +response.statusText);
                        }
                    );
                 };
            }

            function createNewDialogController($scope, $mdDialog, $http){

                $listChecked=[];

                $scope.getInfo = function(){

                    $http({
                        method: 'GET',
                        url: window.location.pathname+'/../../api/channels',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        $scope.allChannels = response.data;
                    }, function error(response){
                        console.log("Error:" +response.statusText);
                    });
                }

                $scope.closeDialog = function() {
                    $mdDialog.hide();
                };

                $scope.alreadyIn = function(user){

                    return ($listChecked).indexOf(channel.name) > -1;
                };

                $scope.toggle = function(channel){
                    var index = ($listChecked).indexOf(channel.name);

                    if (index > -1){
                        ($listChecked).splice(index, 1);
                    }
                    else{
                        ($listChecked).push(channel.name);
                    }

                };

                $scope.create=function(){

                    $notID=-1;
                    $http({
                        method: 'POST',
                        url: window.location.pathname+'/../../api/new/'+$notID,
                        data: {
                            title: $scope.new.title,
                            content: $scope.new.content,
                            //channelsInNew: $scope.allData.channelsInNew
                            channelsInNew: $listChecked
                        },
                        contentType: 'application/json',
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        $scope.closeDialog();
                    }, function error(response){
                        console.log("Error:" +response.statusText);
                    });
                };
            }

            function deleteNewDialogController($scope, $mdDialog, $http, currentNew){
                $scope.new = currentNew;

                $scope.closeDialog = function(){
                    $mdDialog.hide();
                 };


               $scope.delete=function(){
                    $http({
                        method: 'DELETE',
                        url: window.location.pathname+'/../../api/new/'+$scope.new.id,
                        dataType: 'json',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(function success(response){
                        $scope.closeDialog();
                    }, function error(response){
                        console.log("Error al delete:" +response.statusText);
                    });
                };
            }
</script>







    {% set flag=0 %}
    <div ng-cloak ng-app="MyApp" ng-controller="newsController" layout-align="center start">

    <md-list ng-init="getAllNews()">
    <md-button class="md-raised md-primary" ng-click="showCreateNewDialog($event)">Create New</md-button>
    <md-input-container>
        <label>Channels</label>
        <md-select ng-model="selectedItem">
          <md-optgroup label="Channels">
            <md-option ng-value="item" ng-click="selected(item.name)">ALL</md-option>
            <md-option ng-value="item" ng-repeat="item in items" ng-click="selected(item.name)">
                {[{item.name}]}
            </md-option>
          </md-optgroup>
        </md-select>
      </md-input-container>
        <md-divider></md-divider>
        <md-divider></md-divider>

        <md-list-item style="font-size: large" ng-model="prueba">
            <span style="width: 30%">Title</span>
            <span style="width: 50%">Content</span>
        </md-list-item>

        <md-divider></md-divider>
        <md-divider></md-divider>

        <div ng-repeat="n in newsList">
            <md-list-item ng-click="readNewDialog($event, n)">

                <span style="width: 30%">{[{ n.title }]}</span>
                <span style="width: 50%">{[{ n.content }]}</span>
                <div>
                    <md-button style="width: 10%" class="md-raised md-secondary" ng-click="deleteNew($event,n)">
                        <md-icon md-svg-src="{{ asset('bundles/intranet/icons/ic_delete_black_24px.svg') }}" aria-label="android "></md-icon>
                    </md-button>
                </div>

            </md-list-item>
            <md-divider></md-divider>
        </div>
    </md-list>
</div>

{% endblock %}
